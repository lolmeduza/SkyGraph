# Sky Graph — архитектура и план

Расширение на базе FinderV1: панель с чатами, оркестратор по графу и индексу, LLM для перевода запроса, поиска и выполнения задач.

## Структура проекта

Всё строго по папкам, только TypeScript, без дублирования логики.

```
sky-graph/
  docs/           — документация
  src/            — исходники
    panel/        — панель, чаты, UI
    orchestrator/ — граф, индекс, поиск по файлам
    llm/          — провайдеры LLM, системный промпт
    history/      — сохранение/загрузка истории чатов
    context/      — сбор контекста для LLM (файлы, правила)
  out/            — скомпилированный код (генерируется)
```

## Поведение

### Панель

- Одна панель с несколькими чатами (количество не ограничено). Панель не должна закрываться когда пользователь открывает файл 
- В каждом чате: поле запроса, история сообщений, ответы LLM.
- Ввод в поле запроса: перенос на новую строку, а не продолжение в одну строку.
- Отображение ответа LLM: корректная семантика (код, списки, нумерация, цвет/форматирование).

### Контекст LLM

- В контекст можно добавлять произвольное количество файлов.
- Отдельная папка для истории сообщений пользователя.
- Под каждый чат — отдельный файл с историей; история в LLM передаётся в сжатом виде.
- Файл пользовательских правил для LLM: пользователь редактирует его вручную, содержимое отдаётся в контекст при каждом запросе.

### Данные

- Граф и индекс (по аналогии с FinderV1) — основа поиска по проекту.
- Оркестратор принимает запрос поиска и возвращает релевантные фрагменты из графа и индекса.

## Поток работы

1. Пользователь вводит запрос в чат.
2. LLM переводит запрос и разбирает запрос ВСЕГДА и выделяет ключевые слова.
3. По ключевым словам формируется запрос поиска в оркестратор.
4. Оркестратор по графу и индексу возвращает найденные файлы/фрагменты.
5. LLM получает ответ оркестратора, проверяет достаточность контекста и выполняет задачу (дебаг, поиск, создание кода и т.д.).

## Что попадает в контекст LLM

- История сообщений чата (сжатая).
- Файлы, добавленные пользователем в контекст.
- Ответ оркестратора (результат поиска по графу и индексу).
- Системный промпт (отдельно обсудим и доработаем).
- Файл пользовательских правил (содержимое целиком или выбранная часть).

## Дальнейшие шаги

- Копировать из FinderV1 по частям: панель, оркестратор, LLM, история, контекст.
- Собирать и тестировать по шагам, без дублирования логики.
- Системный промпт и правила — уточнить и зафиксировать в отдельном разделе документации.
